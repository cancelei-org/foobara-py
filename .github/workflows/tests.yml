name: Tests

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Enable SSH debugging with tmate'
        required: false
        default: false

jobs:
  test:
    runs-on: self-hosted
    timeout-minutes: 30

    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
      fail-fast: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python via mise
      run: |
        mise use python@${{ matrix.python-version }}
        mise exec -- python --version
        echo "Python location: $(which python)"
        python --version

    - name: Check PostgreSQL availability
      id: postgres-check
      run: |
        if pg_isready -h localhost -p 5432; then
          echo "postgres_available=true" >> $GITHUB_OUTPUT
          echo "âœ… PostgreSQL is available"
        else
          echo "postgres_available=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ PostgreSQL not available - will skip PostgreSQL tests"
        fi

    - name: Set up PostgreSQL test database
      if: steps.postgres-check.outputs.postgres_available == 'true'
      run: |
        # Create test database if it doesn't exist
        psql -h localhost -U $USER -tc "SELECT 1 FROM pg_database WHERE datname = 'foobara_test'" | grep -q 1 || \
        createdb -h localhost -U $USER foobara_test || echo "Database may already exist"

        echo "âœ… PostgreSQL test database ready"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,test]"
        if [ "${{ steps.postgres-check.outputs.postgres_available }}" == "true" ]; then
          pip install psycopg[pool]
          echo "âœ… Installed PostgreSQL driver"
        fi

    - name: Run tests (with PostgreSQL)
      if: steps.postgres-check.outputs.postgres_available == 'true'
      env:
        POSTGRES_TEST_URL: postgresql://${{ env.USER }}@localhost:5432/foobara_test
      run: |
        pytest --cov=foobara_py --cov-report=xml --cov-report=term -v --tb=short
        echo "âœ… Tests completed with PostgreSQL support"

    - name: Run tests (without PostgreSQL)
      if: steps.postgres-check.outputs.postgres_available != 'true'
      run: |
        pytest --cov=foobara_py --cov-report=xml --cov-report=term -v --tb=short
        echo "âœ… Tests completed (PostgreSQL tests skipped)"

    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      if: matrix.python-version == '3.12'
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Generate test summary
      if: always()
      run: |
        echo "## Test Results ðŸ§ª" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Python version:** ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
        echo "**PostgreSQL:** ${{ steps.postgres-check.outputs.postgres_available == 'true' && 'âœ… Enabled' || 'âš ï¸ Disabled' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Get test count
        if [ -f pytest.log ]; then
          grep -E "passed|failed|skipped" pytest.log | tail -1 >> $GITHUB_STEP_SUMMARY || echo "Test stats unavailable" >> $GITHUB_STEP_SUMMARY
        fi

    # SSH debugging step - enable on failure or manual trigger
    - name: Setup tmate session (on failure or manual trigger)
      uses: mxschmitt/action-tmate@v3
      if: ${{ failure() || github.event.inputs.debug_enabled }}
      continue-on-error: true
      timeout-minutes: 30
      with:
        limit-access-to-actor: true
        sudo: false

  lint:
    runs-on: self-hosted
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python via mise
      run: |
        mise use python@3.12
        python --version

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff mypy || echo "Linting tools installation failed - continuing"

    - name: Run ruff (if available)
      continue-on-error: true
      run: |
        if command -v ruff &> /dev/null; then
          echo "## Ruff Linting Results ðŸ”" >> $GITHUB_STEP_SUMMARY
          ruff check foobara_py --output-format=github 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
        else
          echo "âš ï¸ Ruff not available" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Run mypy (if available)
      continue-on-error: true
      run: |
        if command -v mypy &> /dev/null; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## MyPy Type Checking Results ðŸ”" >> $GITHUB_STEP_SUMMARY
          mypy foobara_py --ignore-missing-imports 2>&1 | head -20 | tee -a $GITHUB_STEP_SUMMARY || true
        else
          echo "âš ï¸ MyPy not available" >> $GITHUB_STEP_SUMMARY
        fi

    # SSH debugging step - enable on failure or manual trigger
    - name: Setup tmate session (on failure or manual trigger)
      uses: mxschmitt/action-tmate@v3
      if: ${{ failure() || github.event.inputs.debug_enabled }}
      continue-on-error: true
      timeout-minutes: 30
      with:
        limit-access-to-actor: true
        sudo: false
